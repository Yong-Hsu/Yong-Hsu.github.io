<html lang="en">
<title>Worksheet 1 - Part 1</title>
<meta charset="UTF-8">
<script src="../angel_common/initShaders.js"></script>
<script src="../angel_common/webgl-utils.js"></script>
<script src="../angel_common/MV.js"></script>
<script src="work7/t74.js"></script>

<script id="vertex-shader" type="x-shader/x-vertex">
	attribute vec4 vPosition;
	attribute vec4 vNormal;

	uniform mat4 modelMatrix;
	uniform mat4 viewMatrix;
	uniform mat4 projectionMatrix;

	varying vec4 f_position;
	varying vec4 f_normal;
	
	void main()
	{	
		// todo: understand reflective env mapping
		f_normal = vNormal;
		
		gl_Position = modelMatrix * projectionMatrix * viewMatrix * vPosition;
		f_position = gl_Position;
	}
</script>

<script id="fragment-shader" type="x-shader/x-fragment">
	precision mediump float;
	varying vec4 f_position;
	varying vec4 f_normal;

	uniform samplerCube texMapCube;
	uniform sampler2D texMapSphere;

	uniform mat4 Mtex;
	uniform vec3 eye;
	uniform float reflective;

	vec3 rotate_to_normal(vec3 n, vec3 v);

	void main() {
		vec3 i_w = f_position.xyz - eye; // note that both of them should be in world coordinates
		vec4 texture_coord = Mtex * f_position;

		if (reflective > 1.0) {
			float pi = 2.0 * acos(0.0);
			vec3 n = normalize(f_normal.xyz);

			float u = 1.0 - atan(n.z, n.x) / (2.0*pi);
			float v = acos(n.y) / pi;
			vec4 color = texture2D(texMapSphere, vec2(u, v));

			vec3 tan_n = 2.0 * color.xyz + vec3(-1.0, -1.0, -1.0);
			vec3 bump_n = rotate_to_normal(n, tan_n);

			gl_FragColor = textureCube(texMapCube, reflect(i_w, normalize(bump_n)));
		} else 
			gl_FragColor = textureCube(texMapCube, texture_coord.xyz);
	}
		
	vec3 rotate_to_normal(vec3 n, vec3 v) {
		float sgn_nz = sign(n.z + 1.0e-12);
		float a = -1.0/(1.0 + abs(n.z));
		float b = n.x*n.y*a;
		return vec3(1.0 + n.x*n.x*a, b, -sgn_nz*n.x)*v.x 
			+ vec3(sgn_nz*b, sgn_nz*(1.0 + n.y*n.y*a), -n.y)*v.y 
			+ n*v.z;
	}

</script>

<!-- <body onpageshow="start_code_behind()"> -->
<body>
	<!-- close the canvas tag, make sure button is not included in this element -->
	<canvas id='gl-canvas' height="512" width="512">
        "WebGL isn't available"
    </canvas>
	<br>
</body>

</html>
<!-- https://webglfundamentals.org/webgl/lessons/webgl-how-it-works.html -->